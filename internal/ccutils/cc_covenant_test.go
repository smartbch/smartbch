package ccutils

import (
	"testing"

	"github.com/stretchr/testify/require"

	"github.com/gcash/bchd/chaincfg"
	"github.com/gcash/bchd/txscript"

	"github.com/smartbch/smartbch/internal/testutils"
)

func Test_GetP2SHAddr(t *testing.T) {
	redeemScriptWithoutConstructorArgs := testutils.HexToBytes("5279009c635a795c797e5d797e5e797e5f797e60797e0111797e0112797e0113797e0114797ea952798800717c567a577a587a597a5a7a575c7a5d7a5e7a5f7a607a01117a01127a01137a01147a01157a5aafc3519dc4519d00cc00c602d007949d5379879154797b87919b63011453797e01147e52797ec1012a7f777e02a91478a97e01877e00cd78886d686d7551677b519d547956797e57797ea98800727c52557a567a577a53afc0009d00cc00c69d024065b27501147b7ec101157f777e02a9147ca97e01877e00cd877768")
	operatorPks := [][]byte{
		testutils.HexToBytes("02d86b49e3424e557beebf67bd06842cdb88e314c44887f3f265b7f81107dd6994"),
		testutils.HexToBytes("035c0a0cb8987290ea0a7a926e8aa8978ac042b4c0be8553eb4422461ce1a17cd8"),
		testutils.HexToBytes("03fdec69ef6ec640264045229ca7cf0f170927b87fc8d2047844f8a766ead467e4"),
		testutils.HexToBytes("038fd3d33474e1bd453614f85d8fb1edecae92255867d18a9048669119fb710af5"),
		testutils.HexToBytes("0394ec324d59305638ead14b4f4da9a50c793f1e328e180f92c04a4990bb573af1"),
		testutils.HexToBytes("0271ea0c254ebbb7ed78668ba8653abe222b9f7177642d3a75709d95912a8d9d2c"),
		testutils.HexToBytes("02fbbc3870035c2ee30cfa3102aff15e58bdfc0d0f95998cd7e1eeebc09cdb6873"),
		testutils.HexToBytes("0386f450b1bee3b220c6a9a25515f15f05bd80a23e5f707873dfbac52db933b27d"),
		testutils.HexToBytes("03bfe6f6ecb5e10662481aeb6f6408db2a32b9b86a660acbb8c5374dbb976e53ca"),
		testutils.HexToBytes("03883b732620e238e74041e5fab900234dc80f7a48d56a1bf41e8523c4661f8243"),
	}
	monitorPks := [][]byte{
		testutils.HexToBytes("024a899d685daf6b1999a5c8f2fd3c9ed640d58e92fd0e00cf87cacee8ff1504b8"),
		testutils.HexToBytes("0374ac9ab3415253dbb7e29f46a69a3e51b5d2d66f125b0c9f2dc990b1d2e87e17"),
		testutils.HexToBytes("024cc911ba9d2c7806a217774618b7ba4848ccd33fe664414fc3144d144cdebf7b"),
	}

	c, err := NewCcCovenant(redeemScriptWithoutConstructorArgs, operatorPks, monitorPks, 2000, &chaincfg.TestNet3Params)
	require.NoError(t, err)
	addr, err := c.GetP2SHAddress()
	require.Equal(t, "bchtest:pplmykcc2lale6j6fg4ejsdtlhut6sc08q7uv8pxhm", addr)
}

func Test_BuildRedeemByUserUnlockingScript(t *testing.T) {
	redeemScriptWithoutConstructorArgs := testutils.HexToBytes("5279009c635a795c797e5d797e5e797e5f797e60797e0111797e0112797e0113797e0114797ea952798800717c567a577a587a597a5a7a575c7a5d7a5e7a5f7a607a01117a01127a01137a01147a01157a5aafc3519dc4519d00cc00c602d007949d5379879154797b87919b63011453797e01147e52797ec1012a7f777e02a91478a97e01877e00cd78886d686d7551677b519d547956797e57797ea98800727c52557a567a577a53afc0009d00cc00c69d024065b27501147b7ec101157f777e02a9147ca97e01877e00cd877768")
	operatorPks := [][]byte{
		testutils.HexToBytes("02d86b49e3424e557beebf67bd06842cdb88e314c44887f3f265b7f81107dd6994"),
		testutils.HexToBytes("035c0a0cb8987290ea0a7a926e8aa8978ac042b4c0be8553eb4422461ce1a17cd8"),
		testutils.HexToBytes("03fdec69ef6ec640264045229ca7cf0f170927b87fc8d2047844f8a766ead467e4"),
		testutils.HexToBytes("038fd3d33474e1bd453614f85d8fb1edecae92255867d18a9048669119fb710af5"),
		testutils.HexToBytes("0394ec324d59305638ead14b4f4da9a50c793f1e328e180f92c04a4990bb573af1"),
		testutils.HexToBytes("0271ea0c254ebbb7ed78668ba8653abe222b9f7177642d3a75709d95912a8d9d2c"),
		testutils.HexToBytes("02fbbc3870035c2ee30cfa3102aff15e58bdfc0d0f95998cd7e1eeebc09cdb6873"),
		testutils.HexToBytes("0386f450b1bee3b220c6a9a25515f15f05bd80a23e5f707873dfbac52db933b27d"),
		testutils.HexToBytes("03bfe6f6ecb5e10662481aeb6f6408db2a32b9b86a660acbb8c5374dbb976e53ca"),
		testutils.HexToBytes("03883b732620e238e74041e5fab900234dc80f7a48d56a1bf41e8523c4661f8243"),
	}
	monitorPks := [][]byte{
		testutils.HexToBytes("024a899d685daf6b1999a5c8f2fd3c9ed640d58e92fd0e00cf87cacee8ff1504b8"),
		testutils.HexToBytes("0374ac9ab3415253dbb7e29f46a69a3e51b5d2d66f125b0c9f2dc990b1d2e87e17"),
		testutils.HexToBytes("024cc911ba9d2c7806a217774618b7ba4848ccd33fe664414fc3144d144cdebf7b"),
	}

	c, err := NewCcCovenant(redeemScriptWithoutConstructorArgs, operatorPks, monitorPks, 2000, &chaincfg.TestNet3Params)
	require.NoError(t, err)

	sigScript, err := c.BuildRedeemByUserUnlockingScript([][]byte{
		testutils.HexToBytes("0x304402203b289d27eed12a2abb874c41a36bee14c5a4340f34e1306c21b32fad2040613b022061db8baa44af6adffc0f420bd7ff40b23501fb0d3a32e86e718730e2729d965841"),
		testutils.HexToBytes("0x30440220081a832b6f0beef5a2311bc24eb818bb34e598d88fa9cc217b41e4d88cc517de02203f158e5746f481a4676c3cbe7edd6a2e648a2294552458d64fea0dda27ad72ed41"),
		testutils.HexToBytes("0x3045022100a2e36c1b73bfe1baa2eb4a44c5ee675eaee67e85a26eecf5d54cbddf655ba3e802207fb19769f4e9ba97093af84a1bc96465c76c9a4d10b23d76d84049d6e9517c9141"),
		testutils.HexToBytes("0x30440220541a6035542abd33b318584b01a62ea4678e4d407e28ec5c4a1d98be8da20a7802203e05ae652cb0a8f615fca5a0531df7111da80a7985598f446761ccf7ccbea8b241"),
		testutils.HexToBytes("0x304402205b5d26db1d7cd4b9ddebef0c3a74124d5b8ce549946d2ddcd6ba9121d8adb886022038d0572915960a1e1ca4e921c4bf6432e336f83e2c2a5f7e48697783d8ef92fd41"),
		testutils.HexToBytes("0x30440220148300596475fd0b80c2e9704caa4a77485ab50e6666b80dec73d067ed38a30402205385a562dde1c06e15d33280b32908ce2ca42f6ef9760feb646679fafe1aeaae41"),
		testutils.HexToBytes("0x304402207bd5dd3fce07a56d28a1e456c538901fbc9820f52855f5502ecb7c5a35b05d41022027611a420ba0617764672d11bf908c7f31b6f05f66ca2268fa3135f68951521441"),
	})
	require.NoError(t, err)
	require.Equal(t, testutils.HexToBytes("0x14553fac4027a7a3c4e8a3eaea75aab173d3c8144b1427c4ca4766591e6bb8cd71b83143946c53eaf9a32103883b732620e238e74041e5fab900234dc80f7a48d56a1bf41e8523c4661f82432103bfe6f6ecb5e10662481aeb6f6408db2a32b9b86a660acbb8c5374dbb976e53ca210386f450b1bee3b220c6a9a25515f15f05bd80a23e5f707873dfbac52db933b27d2102fbbc3870035c2ee30cfa3102aff15e58bdfc0d0f95998cd7e1eeebc09cdb6873210271ea0c254ebbb7ed78668ba8653abe222b9f7177642d3a75709d95912a8d9d2c210394ec324d59305638ead14b4f4da9a50c793f1e328e180f92c04a4990bb573af121038fd3d33474e1bd453614f85d8fb1edecae92255867d18a9048669119fb710af52103fdec69ef6ec640264045229ca7cf0f170927b87fc8d2047844f8a766ead467e421035c0a0cb8987290ea0a7a926e8aa8978ac042b4c0be8553eb4422461ce1a17cd82102d86b49e3424e557beebf67bd06842cdb88e314c44887f3f265b7f81107dd699447304402207bd5dd3fce07a56d28a1e456c538901fbc9820f52855f5502ecb7c5a35b05d41022027611a420ba0617764672d11bf908c7f31b6f05f66ca2268fa3135f689515214414730440220148300596475fd0b80c2e9704caa4a77485ab50e6666b80dec73d067ed38a30402205385a562dde1c06e15d33280b32908ce2ca42f6ef9760feb646679fafe1aeaae4147304402205b5d26db1d7cd4b9ddebef0c3a74124d5b8ce549946d2ddcd6ba9121d8adb886022038d0572915960a1e1ca4e921c4bf6432e336f83e2c2a5f7e48697783d8ef92fd414730440220541a6035542abd33b318584b01a62ea4678e4d407e28ec5c4a1d98be8da20a7802203e05ae652cb0a8f615fca5a0531df7111da80a7985598f446761ccf7ccbea8b241483045022100a2e36c1b73bfe1baa2eb4a44c5ee675eaee67e85a26eecf5d54cbddf655ba3e802207fb19769f4e9ba97093af84a1bc96465c76c9a4d10b23d76d84049d6e9517c91414730440220081a832b6f0beef5a2311bc24eb818bb34e598d88fa9cc217b41e4d88cc517de02203f158e5746f481a4676c3cbe7edd6a2e648a2294552458d64fea0dda27ad72ed4147304402203b289d27eed12a2abb874c41a36bee14c5a4340f34e1306c21b32fad2040613b022061db8baa44af6adffc0f420bd7ff40b23501fb0d3a32e86e718730e2729d965841004cf914553fac4027a7a3c4e8a3eaea75aab173d3c8144b1427c4ca4766591e6bb8cd71b83143946c53eaf9a35279009c635a795c797e5d797e5e797e5f797e60797e0111797e0112797e0113797e0114797ea952798800717c567a577a587a597a5a7a575c7a5d7a5e7a5f7a607a01117a01127a01137a01147a01157a5aafc3519dc4519d00cc00c602d007949d5379879154797b87919b63011453797e01147e52797ec1012a7f777e02a91478a97e01877e00cd78886d686d7551677b519d547956797e57797ea98800727c52557a567a577a53afc0009d00cc00c69d024065b27501147b7ec101157f777e02a9147ca97e01877e00cd877768"),
		sigScript)
}

func Test_UserRedeemTx(t *testing.T) {
	redeemScriptWithoutConstructorArgs := testutils.HexToBytes("5279009c635a795c797e5d797e5e797e5f797e60797e0111797e0112797e0113797e0114797ea952798800717c567a577a587a597a5a7a575c7a5d7a5e7a5f7a607a01117a01127a01137a01147a01157a5aafc3519dc4519d00cc00c602d007949d5379879154797b87919b63011453797e01147e52797ec1012a7f777e02a91478a97e01877e00cd78886d686d7551677b519d547956797e57797ea98800727c52557a567a577a53afc0009d00cc00c69d024065b27501147b7ec101157f777e02a9147ca97e01877e00cd877768")
	operatorPks := [][]byte{
		testutils.HexToBytes("02d86b49e3424e557beebf67bd06842cdb88e314c44887f3f265b7f81107dd6994"),
		testutils.HexToBytes("035c0a0cb8987290ea0a7a926e8aa8978ac042b4c0be8553eb4422461ce1a17cd8"),
		testutils.HexToBytes("03fdec69ef6ec640264045229ca7cf0f170927b87fc8d2047844f8a766ead467e4"),
		testutils.HexToBytes("038fd3d33474e1bd453614f85d8fb1edecae92255867d18a9048669119fb710af5"),
		testutils.HexToBytes("0394ec324d59305638ead14b4f4da9a50c793f1e328e180f92c04a4990bb573af1"),
		testutils.HexToBytes("0271ea0c254ebbb7ed78668ba8653abe222b9f7177642d3a75709d95912a8d9d2c"),
		testutils.HexToBytes("02fbbc3870035c2ee30cfa3102aff15e58bdfc0d0f95998cd7e1eeebc09cdb6873"),
		testutils.HexToBytes("0386f450b1bee3b220c6a9a25515f15f05bd80a23e5f707873dfbac52db933b27d"),
		testutils.HexToBytes("03bfe6f6ecb5e10662481aeb6f6408db2a32b9b86a660acbb8c5374dbb976e53ca"),
		testutils.HexToBytes("03883b732620e238e74041e5fab900234dc80f7a48d56a1bf41e8523c4661f8243"),
	}
	monitorPks := [][]byte{
		testutils.HexToBytes("024a899d685daf6b1999a5c8f2fd3c9ed640d58e92fd0e00cf87cacee8ff1504b8"),
		testutils.HexToBytes("0374ac9ab3415253dbb7e29f46a69a3e51b5d2d66f125b0c9f2dc990b1d2e87e17"),
		testutils.HexToBytes("024cc911ba9d2c7806a217774618b7ba4848ccd33fe664414fc3144d144cdebf7b"),
	}

	c, err := NewCcCovenant(redeemScriptWithoutConstructorArgs, operatorPks, monitorPks, 2000, &chaincfg.TestNet3Params)
	require.NoError(t, err)

	txid := "c70ae4cd69afad7ac025c719055e2eefe18e3942259c2882d7afb0c39ae339ef"
	vout := uint32(0)
	inAmt := int64(10000)
	toAddr := "bchtest:qzvu0c953gzu6cpykgkdfy8uacc255wcvgmp7ekj7y"
	//outAmt := int64(8000) // gasFee = 2000

	unsignedTx, sigHash, err := c.GetRedeemByUserTxSigHash(txid, vout, inAmt, toAddr)
	require.NoError(t, err)

	operatorWIFs := []string{
		"L482yD31EhZopxRD3V19QEANQaYkcUZfgNKYY2TV4RTCXa6izAKo",
		"L4JzvBMUmkQCTdz2zbVgTyW8dDMvMU8HFwe413qfnBxW3vKSw6sm",
		"L3vi8Z3HJUQw3iXcgRkbcPVku6R1XA2V6iLCG6NeuqRTvt4mUV6K",
		"L5mXQBYy1nKMTxXA3LmvUVH9pfBeaKzCKiYNszkj88s2vQEocyUs",
		"L15emxZt9yyY6ZxxRGvKRm72CMZaCRDKbSRmdRwu5h2wCUGdfwwb",
		"L5X85r9Bbf86jyf4wSRXxttPwWmkcGcv2tHhZ9eD6YiNZnZcPqZX",
		"L3HPpfMVSmYN9Y3tVJT2UorzNyWjZEQMHHuJmZKnwAGpudpA1o93",
		"L44W5cEBFAY4kcSm5q7ch8Ko3AsXV1MfJDDq1oq1u797EkhutH8s",
		"KxnPxfZ3VJtdfJm7dk1g4PeHJWz9BqRJwk6wfdNMTqeUiJJRphzD",
		"KzPnubj5tnS8efj2nApUK3wnsHCKAS6khHYxPCaciT474mNs6vfJ",
	}

	var sigs [][]byte
	hashType := txscript.SigHashAll | txscript.SigHashForkID
	for i := 0; i < 7; i++ {
		sig, err := SignCcCovenantTxSigHashECDSA(operatorWIFs[i], sigHash, hashType)
		require.NoError(t, err, i)
		sigs = append(sigs, sig)
	}

	//pkh := testutils.HexToBytes("99c7e0b48a05cd6024b22cd490fcee30aa51d862")
	rawTx, err := c.FinishRedeemByUserTx(unsignedTx, sigs)
	require.NoError(t, err)
	//println("rawTx:", rawTx)

	expectedTxHex := "0200000001ef39e39ac3b0afd782289c2542398ee1ef2e5e0519c725c07aadaf69cde40ac700000000fd730414553fac4027a7a3c4e8a3eaea75aab173d3c8144b1427c4ca4766591e6bb8cd71b83143946c53eaf9a32103883b732620e238e74041e5fab900234dc80f7a48d56a1bf41e8523c4661f82432103bfe6f6ecb5e10662481aeb6f6408db2a32b9b86a660acbb8c5374dbb976e53ca210386f450b1bee3b220c6a9a25515f15f05bd80a23e5f707873dfbac52db933b27d2102fbbc3870035c2ee30cfa3102aff15e58bdfc0d0f95998cd7e1eeebc09cdb6873210271ea0c254ebbb7ed78668ba8653abe222b9f7177642d3a75709d95912a8d9d2c210394ec324d59305638ead14b4f4da9a50c793f1e328e180f92c04a4990bb573af121038fd3d33474e1bd453614f85d8fb1edecae92255867d18a9048669119fb710af52103fdec69ef6ec640264045229ca7cf0f170927b87fc8d2047844f8a766ead467e421035c0a0cb8987290ea0a7a926e8aa8978ac042b4c0be8553eb4422461ce1a17cd82102d86b49e3424e557beebf67bd06842cdb88e314c44887f3f265b7f81107dd6994473044022031427dd1f45b9da87a7debd1b87ed4ecded757229fe4303d53622218f6ad03bc0220620d22921ebc048ce3b059a90fbd6b73bb4317eac8381fda0536122ca6d551e041473044022036b4e61517de41dff076c8ee34086144b3e0dd6643630fc3346b5c3cbe70b188022035eb4b9416cc6f57866223c09d7b7fa689107b9f8e602a50e72b10e854c58f8841473044022061f3679773b8614476ed86fcb9bd6e2e8583fa7d31f40ea8253828e8ec557494022062464d5b18009799ad2da29eb3434e39a337b92da8782110c4eff88cb189cc0a4147304402207dda8c8c17b45d59f9db2dd2c9100e199055efb9d0ae9d8288b89343e40f07320220049f93711440f3430758296e5557db9a1f6f8cdb18ecd86994ed42da932fd00c41483045022100e33a551d632b8d011160adad33cbe9313398f4eda81a4638f5b882e24df3b3ab02201499477ce35e4fe2dbb068308cf74990cbb51fa6ed923cf2f68dac5e010744c74147304402200dbc8ad06836f0a24d60da54fb2afb8db854864e5ca1bb4d982fde792500c6330220720d6f7246c23e5edf4770fbbb0e5c3680e72204be28ce2491ee9442fb62b0724147304402206f858c771e95ca1e4fac2e5580ca5b989a2ac447741154189fb99f044839eee0022049aa497292adadb2ffbdbb10a2d997f1210a0e4aa1acd354551e972db2fed00841004cf914553fac4027a7a3c4e8a3eaea75aab173d3c8144b1427c4ca4766591e6bb8cd71b83143946c53eaf9a35279009c635a795c797e5d797e5e797e5f797e60797e0111797e0112797e0113797e0114797ea952798800717c567a577a587a597a5a7a575c7a5d7a5e7a5f7a607a01117a01127a01137a01147a01157a5aafc3519dc4519d00cc00c602d007949d5379879154797b87919b63011453797e01147e52797ec1012a7f777e02a91478a97e01877e00cd78886d686d7551677b519d547956797e57797ea98800727c52557a567a577a53afc0009d00cc00c69d024065b27501147b7ec101157f777e02a9147ca97e01877e00cd877768ffffffff01401f0000000000001976a91499c7e0b48a05cd6024b22cd490fcee30aa51d86288ac00000000"
	require.Equal(t, expectedTxHex, rawTx)
}
